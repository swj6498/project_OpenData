-- ===============================
-- 게시판 댓글 테이블 생성
-- ===============================
BEGIN 
    EXECUTE IMMEDIATE 'DROP TABLE post_board_comment CASCADE CONSTRAINTS PURGE'; 
    EXCEPTION WHEN OTHERS THEN NULL; 
END;
/

BEGIN 
    EXECUTE IMMEDIATE 'DROP SEQUENCE POST_BOARD_COMMENT_SEQ'; 
    EXCEPTION WHEN OTHERS THEN NULL; 
END;
/

-- ===== 게시판 댓글 테이블 =====
CREATE TABLE post_board_comment (
  comment_no        NUMBER         PRIMARY KEY,
  board_no          NUMBER         NOT NULL,
  user_id           VARCHAR2(60)   NOT NULL,
  comment_content   VARCHAR2(1000) NOT NULL,
  comment_date      TIMESTAMP(6)   DEFAULT SYSTIMESTAMP NOT NULL,
  parent_comment_no NUMBER,                    -- 대댓글용 (NULL이면 원댓글)
  is_deleted        CHAR(1)        DEFAULT 'N' NOT NULL  -- 'Y' or 'N' (소프트 삭제)
);

-- PK 시퀀스
CREATE SEQUENCE POST_BOARD_COMMENT_SEQ START WITH 1 INCREMENT BY 1 NOCACHE;

-- FK (게시글 삭제 시 댓글도 삭제)
ALTER TABLE post_board_comment
  ADD CONSTRAINT fk_pbc_board
  FOREIGN KEY (board_no)
  REFERENCES post_board(board_no)
  ON DELETE CASCADE;

-- 대댓글 FK (부모 댓글 삭제 시 대댓글도 삭제)
ALTER TABLE post_board_comment
  ADD CONSTRAINT fk_pbc_parent
  FOREIGN KEY (parent_comment_no)
  REFERENCES post_board_comment(comment_no)
  ON DELETE CASCADE;

-- 삭제 여부 체크 제약조건
ALTER TABLE post_board_comment
  ADD CONSTRAINT chk_pbc_is_deleted CHECK (is_deleted IN ('Y', 'N'));

-- 조회 성능 향상용 인덱스
CREATE INDEX idx_pbc_board_date ON post_board_comment(board_no, comment_date);
CREATE INDEX idx_pbc_user ON post_board_comment(user_id);
CREATE INDEX idx_pbc_parent ON post_board_comment(parent_comment_no);

-- ===============================
-- 공지사항 댓글 테이블 생성
-- ===============================
BEGIN 
    EXECUTE IMMEDIATE 'DROP TABLE notice_board_comment CASCADE CONSTRAINTS PURGE'; 
    EXCEPTION WHEN OTHERS THEN NULL; 
END;
/

BEGIN 
    EXECUTE IMMEDIATE 'DROP SEQUENCE NOTICE_BOARD_COMMENT_SEQ'; 
    EXCEPTION WHEN OTHERS THEN NULL; 
END;
/

-- ===== 공지사항 댓글 테이블 =====
CREATE TABLE notice_board_comment (
  comment_no        NUMBER         PRIMARY KEY,
  notice_no         NUMBER         NOT NULL,
  user_id           VARCHAR2(60)   NOT NULL,
  comment_content   VARCHAR2(1000) NOT NULL,
  comment_date      TIMESTAMP(6)   DEFAULT SYSTIMESTAMP NOT NULL,
  parent_comment_no NUMBER,                    -- 대댓글용 (NULL이면 원댓글)
  is_deleted        CHAR(1)        DEFAULT 'N' NOT NULL  -- 'Y' or 'N' (소프트 삭제)
);

-- PK 시퀀스
CREATE SEQUENCE NOTICE_BOARD_COMMENT_SEQ
  START WITH 1
  INCREMENT BY 1
  NOCACHE;

-- FK (공지사항 삭제 시 댓글도 삭제)
ALTER TABLE notice_board_comment
  ADD CONSTRAINT fk_nbc_notice
  FOREIGN KEY (notice_no)
  REFERENCES notice_board(notice_no)
  ON DELETE CASCADE;

-- 대댓글 FK (부모 댓글 삭제 시 대댓글도 삭제)
ALTER TABLE notice_board_comment
  ADD CONSTRAINT fk_nbc_parent
  FOREIGN KEY (parent_comment_no)
  REFERENCES notice_board_comment(comment_no)
  ON DELETE CASCADE;

-- 삭제 여부 체크 제약조건
ALTER TABLE notice_board_comment
  ADD CONSTRAINT chk_nbc_is_deleted CHECK (is_deleted IN ('Y', 'N'));

-- 조회 성능 향상용 인덱스
CREATE INDEX idx_nbc_notice_date ON notice_board_comment(notice_no, comment_date);
CREATE INDEX idx_nbc_user ON notice_board_comment(user_id);
CREATE INDEX idx_nbc_parent ON notice_board_comment(parent_comment_no);

COMMIT;

-- ===============================
-- 댓글 삭제 프로시저 생성 (부모 댓글 삭제 시 자식 답글들도 함께 삭제)
-- ===============================

-- 게시판 댓글 삭제 프로시저 (소프트 삭제 - 부모와 모든 자식 답글 포함)
CREATE OR REPLACE PROCEDURE delete_board_comment(
    p_comment_no IN NUMBER
) IS
BEGIN
    -- 부모 댓글과 모든 자식 답글들을 재귀적으로 찾아서 삭제
    UPDATE post_board_comment
    SET is_deleted = 'Y'
    WHERE comment_no IN (
        SELECT comment_no
        FROM post_board_comment
        START WITH comment_no = p_comment_no
        CONNECT BY PRIOR comment_no = parent_comment_no
    );
    
    COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END delete_board_comment;
/

-- 공지사항 댓글 삭제 프로시저 (소프트 삭제 - 부모와 모든 자식 답글 포함)
CREATE OR REPLACE PROCEDURE delete_notice_comment(
    p_comment_no IN NUMBER
) IS
BEGIN
    -- 부모 댓글과 모든 자식 답글들을 재귀적으로 찾아서 삭제
    UPDATE notice_board_comment
    SET is_deleted = 'Y'
    WHERE comment_no IN (
        SELECT comment_no
        FROM notice_board_comment
        START WITH comment_no = p_comment_no
        CONNECT BY PRIOR comment_no = parent_comment_no
    );
    
    COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END delete_notice_comment;
/


-- 전체 댓글 삭제
DELETE FROM post_board_comment;
COMMIT;

-- 게시판 댓글 전체 조회
SELECT
    comment_no,
    board_no,
    user_id,
    comment_content,
    TO_CHAR(comment_date, 'YYYY-MM-DD HH24:MI:SS') AS comment_date,
    parent_comment_no,
    is_deleted
FROM post_board_comment
ORDER BY comment_no DESC;

-- 공지사항 댓글 전체 조회
SELECT
    comment_no,
    notice_no,
    user_id,
    comment_content,
    TO_CHAR(comment_date, 'YYYY-MM-DD HH24:MI:SS') AS comment_date,
    parent_comment_no,
    is_deleted
FROM notice_board_comment
ORDER BY comment_no DESC;



