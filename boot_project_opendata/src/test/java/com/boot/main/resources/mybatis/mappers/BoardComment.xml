<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.boot.dao.BoardCommentDAO">

  <!-- ✅ resultMap -->
  <resultMap id="BoardCommentMap" type="com.boot.dto.BoardCommentDTO">
    <id column="comment_no" property="commentNo"/>
    <result column="board_no" property="boardNo"/>
    <result column="user_id" property="userId"/>
    <result column="user_nickname" property="userNickname"/>
    <result column="comment_content" property="commentContent"/>
    <result column="comment_date" property="commentDate"/>
    <result column="parent_comment_no" property="parentCommentNo"/>
    <result column="is_deleted" property="isDeleted"/>
  </resultMap>

  <!-- ✅ 댓글 등록 -->
  <insert id="insert" parameterType="com.boot.dto.BoardCommentDTO">
    <selectKey keyProperty="commentNo" resultType="long" order="BEFORE">
      SELECT POST_BOARD_COMMENT_SEQ.NEXTVAL FROM dual
    </selectKey>
    INSERT INTO post_board_comment (
      comment_no, board_no, user_id, comment_content, comment_date, parent_comment_no, is_deleted
    ) VALUES (
      #{commentNo}, #{boardNo}, #{userId}, #{commentContent}, SYSTIMESTAMP, 
      #{parentCommentNo, jdbcType=NUMERIC}, 'N'
    )
  </insert>

  <!-- ✅ 게시글별 댓글 목록 조회 (최신순 정렬 - 댓글 번호 기준) -->
  <select id="selectByBoardNo" parameterType="long" resultMap="BoardCommentMap">
    SELECT 
      c.comment_no, c.board_no, c.user_id, u.user_nickname, 
      c.comment_content, c.comment_date, c.parent_comment_no, c.is_deleted
    FROM post_board_comment c
    LEFT JOIN opendata_users u ON c.user_id = u.user_id
    WHERE c.board_no = #{boardNo}
      AND c.is_deleted = 'N'
    ORDER BY c.comment_no DESC
  </select>

  <!-- ✅ 게시글별 원댓글 목록 조회 (페이징, 최신순 - 댓글 번호 기준) -->
  <select id="selectParentCommentsByBoardNo" resultMap="BoardCommentMap">
    <![CDATA[
    SELECT 
      comment_no, board_no, user_id, user_nickname, 
      comment_content, comment_date, parent_comment_no, is_deleted
    FROM (
      SELECT 
        c.comment_no, c.board_no, c.user_id, u.user_nickname, 
        c.comment_content, c.comment_date, c.parent_comment_no, c.is_deleted,
        ROW_NUMBER() OVER (ORDER BY c.comment_no DESC) AS rn
      FROM post_board_comment c
      LEFT JOIN opendata_users u ON c.user_id = u.user_id
      WHERE c.board_no = #{boardNo}
        AND c.is_deleted = 'N'
        AND c.parent_comment_no IS NULL
    ) WHERE rn > #{offset} AND rn <= #{offset} + #{limit}
    ORDER BY comment_no DESC
    ]]> 
  </select>

  <!-- ✅ 게시글별 전체 댓글 목록 조회 (페이징, 최신순 - 댓글 번호 기준) -->
  <select id="selectAllCommentsByBoardNo" resultMap="BoardCommentMap">
    <![CDATA[
    SELECT 
      comment_no, board_no, user_id, user_nickname, 
      comment_content, comment_date, parent_comment_no, is_deleted
    FROM (
      SELECT 
        c.comment_no, c.board_no, c.user_id, u.user_nickname, 
        c.comment_content, c.comment_date, c.parent_comment_no, c.is_deleted,
        ROW_NUMBER() OVER (ORDER BY c.comment_no DESC) AS rn
      FROM post_board_comment c
      LEFT JOIN opendata_users u ON c.user_id = u.user_id
      WHERE c.board_no = #{boardNo}
        AND c.is_deleted = 'N'
    ) WHERE rn > #{offset} AND rn <= #{offset} + #{limit}
    ORDER BY comment_no DESC
    ]]> 
  </select>

  <!-- ✅ 게시글별 원댓글 개수 -->
  <select id="countParentCommentsByBoardNo" parameterType="long" resultType="int">
    SELECT COUNT(*)
    FROM post_board_comment
    WHERE board_no = #{boardNo}
      AND is_deleted = 'N'
      AND parent_comment_no IS NULL
  </select>

  <!-- ✅ 특정 원댓글의 모든 답글 조회 (재귀적으로 모든 하위 답글 포함, 최신순 - 댓글 번호 기준) -->
  <select id="selectRepliesByParentNo" parameterType="long" resultMap="BoardCommentMap">
    SELECT 
      c.comment_no, c.board_no, c.user_id, u.user_nickname, 
      c.comment_content, c.comment_date, c.parent_comment_no, c.is_deleted
    FROM post_board_comment c
    LEFT JOIN opendata_users u ON c.user_id = u.user_id
    START WITH c.parent_comment_no = #{parentCommentNo}
      AND c.is_deleted = 'N'
    CONNECT BY PRIOR c.comment_no = c.parent_comment_no
    ORDER SIBLINGS BY c.comment_no DESC
  </select>

  <!-- ✅ 댓글 단건 조회 -->
  <select id="find" parameterType="long" resultMap="BoardCommentMap">
    SELECT 
      c.comment_no, c.board_no, c.user_id, u.user_nickname,
      c.comment_content, c.comment_date, c.parent_comment_no, c.is_deleted
    FROM post_board_comment c
    LEFT JOIN opendata_users u ON c.user_id = u.user_id
    WHERE c.comment_no = #{commentNo}
  </select>

  <!-- ✅ 댓글 수정 -->
  <update id="update" parameterType="com.boot.dto.BoardCommentDTO">
    UPDATE post_board_comment
    SET comment_content = #{commentContent}
    WHERE comment_no = #{commentNo}
  </update>

  <!-- ✅ 댓글 삭제 (물리적 삭제 - 부모와 모든 자식 답글 포함) -->
  <delete id="delete" parameterType="long">
    <![CDATA[
    DELETE FROM post_board_comment
    WHERE comment_no IN (
      WITH comment_tree AS (
        SELECT comment_no
        FROM post_board_comment
        START WITH comment_no = #{commentNo}
        CONNECT BY PRIOR comment_no = parent_comment_no
      )
      SELECT comment_no FROM comment_tree
    )
    ]]> 
  </delete>

  <!-- ✅ 게시글별 댓글 개수 -->
  <select id="countByBoardNo" parameterType="long" resultType="int">
    SELECT COUNT(*)
    FROM post_board_comment
    WHERE board_no = #{boardNo}
      AND is_deleted = 'N'
  </select>

  <!-- ✅ 댓글 작성자 확인 -->
  <select id="getUserIdByCommentNo" parameterType="long" resultType="string">
    SELECT user_id
    FROM post_board_comment
    WHERE comment_no = #{commentNo}
  </select>

</mapper>
