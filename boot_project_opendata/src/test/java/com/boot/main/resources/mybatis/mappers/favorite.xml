<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.boot.dao.FavoriteStationDAO">

  <!-- FAVORITE_STATION 기본 매핑 -->
  <resultMap id="FavoriteStationMap" type="com.boot.dto.FavoriteStationDTO">
    <id     property="favoriteId"  column="favorite_id" />
    <result property="userId"      column="user_id" />
    <!-- stationId 는 당장 안 씀: 필요하면 나중에 다시 매핑 -->
    <result property="stationName" column="station_name" />
    <result property="createdAt"   column="created_at" />
  </resultMap>

  <!-- 마이페이지 / 목록 조회 -->
  <select id="getFavoriteList"
          parameterType="string"
          resultMap="FavoriteStationMap">
    SELECT
      favorite_id,
      user_id,
      station_name,
      created_at
    FROM FAVORITE_STATION
    WHERE user_id = #{userId}
    ORDER BY favorite_id ASC
  </select>

  <!-- 추가 INSERT: station_id 제거 -->
  <insert id="insertFavorite" parameterType="com.boot.dto.FavoriteStationDTO">
    INSERT INTO FAVORITE_STATION
      (favorite_id, user_id, station_name, created_at)
    VALUES
      (SEQ_FAVORITE_STATION.NEXTVAL,
       #{userId},
       #{stationName},
       SYSTIMESTAMP)
  </insert>

  <!-- (옵션) MERGE upsert: user_id + station_name 기준 -->
  <insert id="upsertFavorite" parameterType="com.boot.dto.FavoriteStationDTO">
    MERGE INTO FAVORITE_STATION t
    USING (
      SELECT
        #{userId}      AS user_id,
        #{stationName} AS station_name
      FROM dual
    ) s
    ON (t.user_id = s.user_id AND t.station_name = s.station_name)
    WHEN MATCHED THEN
      UPDATE SET
        t.station_name = s.station_name,
        t.created_at   = SYSTIMESTAMP
    WHEN NOT MATCHED THEN
      INSERT (favorite_id, user_id, station_name, created_at)
      VALUES (SEQ_FAVORITE_STATION.NEXTVAL,
              s.user_id,
              s.station_name,
              SYSTIMESTAMP)
  </insert>

  <!-- 삭제: user_id + station_name -->
  <delete id="deleteFavorite">
    DELETE FROM FAVORITE_STATION
    WHERE user_id      = #{userId}
      AND station_name = #{stationName}
  </delete>

  <!-- favoriteId 로 삭제 -->
  <delete id="deleteFavoriteById" parameterType="long">
    DELETE FROM FAVORITE_STATION
    WHERE favorite_id = #{favoriteId}
  </delete>

  <!-- 유저별 목록 -->
  <select id="selectFavoritesByUser" resultMap="FavoriteStationMap">
    SELECT
      favorite_id,
      user_id,
      station_name,
      created_at
    FROM FAVORITE_STATION
    WHERE user_id = #{userId}
    ORDER BY created_at DESC
  </select>

  <!-- 단건 조회: user_id + station_name -->
  <select id="selectFavoriteOne" resultMap="FavoriteStationMap">
    SELECT
      favorite_id,
      user_id,
      station_name,
      created_at
    FROM FAVORITE_STATION
    WHERE user_id      = #{userId}
      AND station_name = #{stationName}
  </select>

</mapper>
